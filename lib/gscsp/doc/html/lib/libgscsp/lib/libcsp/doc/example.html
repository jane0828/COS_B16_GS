

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>3.2.3.9. Client and server example &mdash; Product Interface Application 2.1.1 documentation</title>
  

  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="../../../../../_static/css/theme.css" type="text/css" />
  

  

  
        <link rel="index" title="Index"
              href="../../../../../genindex.html"/>
        <link rel="search" title="Search" href="../../../../../search.html"/>
    <link rel="top" title="Product Interface Application 2.1.1 documentation" href="../../../../../index.html"/>
        <link rel="up" title="3.2.3. CubeSat Space Protocol" href="libcsp.html"/>
        <link rel="next" title="3.3. Flight Planner (libfp_client)" href="../../../../libfp_client/doc/libfp_client.html"/>
        <link rel="prev" title="3.2.3.8. Maximum Transfer Unit" href="mtu.html"/> 

  
  <script src="../../../../../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../../../../../doc/index.html" class="icon icon-home"> Product Interface Application
          

          
          </a>

          
            
            
              <div class="version">
                2.1.1
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
                <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../../../../doc/csp-client.html">1. Product Interface Application</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../doc/product_interfaces.html">2. Product Interfaces</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../../../../../doc/libraries.html">3. Libraries</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../../../../libaardvark/doc/libaardvark.html">3.1. Aardvark (libaardvark)</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="../../../doc/libgscsp.html">3.2. GomSpace CSP (libgscsp)</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="../../../doc/introduction.html">3.2.1. Introduction</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../doc/commands.html">3.2.2. Commands</a></li>
<li class="toctree-l3 current"><a class="reference internal" href="libcsp.html">3.2.3. CubeSat Space Protocol</a><ul class="current">
<li class="toctree-l4"><a class="reference internal" href="../README.html">3.2.3.1. The Cubesat Space Protocol</a></li>
<li class="toctree-l4"><a class="reference internal" href="history.html">3.2.3.2. History</a></li>
<li class="toctree-l4"><a class="reference internal" href="structure.html">3.2.3.3. Structure</a></li>
<li class="toctree-l4"><a class="reference internal" href="interfaces.html">3.2.3.4. CSP Interfaces</a></li>
<li class="toctree-l4"><a class="reference internal" href="memory.html">3.2.3.5. How CSP uses memory</a></li>
<li class="toctree-l4"><a class="reference internal" href="protocolstack.html">3.2.3.6. The Protocol Stack</a></li>
<li class="toctree-l4"><a class="reference internal" href="topology.html">3.2.3.7. Network Topology</a></li>
<li class="toctree-l4"><a class="reference internal" href="mtu.html">3.2.3.8. Maximum Transfer Unit</a></li>
<li class="toctree-l4 current"><a class="current reference internal" href="#">3.2.3.9. Client and server example</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../../libfp_client/doc/libfp_client.html">3.3. Flight Planner (libfp_client)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../libftp_client/doc/libftp_client.html">3.4. FTP (libftp_client)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../libgosh_client/doc/libgosh_client.html">3.5. GOSH (libgosh_client)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../libgssb_client/doc/libgssb_client.html">3.6. GomSpace Sensor Bus (libgssb_client)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../libhk_client/doc/libhk_client.html">3.7. Housekeeping (libhk_client)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../libnanopb/doc/libnanopb.html">3.8. Nano Protobuf (libnanopb)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../libparam_client/doc/libparam_client.html">3.9. Parameter System (libparam_client)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../librgosh_client/doc/librgosh_client.html">3.10. Remote GOSH (librgosh_client)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../libutil/doc/libutil.html">3.11. Utility (libutil)</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../doc/tools.html">4. Tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../doc/appendix/appendix.html">5. Appendix</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../../../../../doc/index.html">Product Interface Application</a>
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          

 



<div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../../../../../doc/index.html">Docs</a> &raquo;</li>
      
          <li><a href="../../../../../doc/libraries.html">3. Libraries</a> &raquo;</li>
      
          <li><a href="../../../doc/libgscsp.html">3.2. GomSpace CSP (libgscsp)</a> &raquo;</li>
      
          <li><a href="libcsp.html">3.2.3. CubeSat Space Protocol</a> &raquo;</li>
      
    <li>3.2.3.9. Client and server example</li>
      <li class="wy-breadcrumbs-aside">
        
          
        
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="client-and-server-example">
<h1>3.2.3.9. Client and server example<a class="headerlink" href="#client-and-server-example" title="Permalink to this headline">¶</a></h1>
<p>The following examples show the initialization of the protocol stack and examples of client/server code.</p>
<div class="section" id="initialization-sequence">
<h2>3.2.3.9.1. Initialization Sequence<a class="headerlink" href="#initialization-sequence" title="Permalink to this headline">¶</a></h2>
<p>This code initializes the CSP buffer system, device drivers and router core. The example uses the CAN interface function csp_can_tx but the initialization is similar for other interfaces. The loopback interface does not require any explicit initialization.</p>
<div class="highlight-c"><div class="highlight"><pre><span class="cp">#include</span> <span class="cpf">&lt;csp/csp.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;csp/interfaces/csp_if_can.h&gt;</span><span class="cp"></span>

<span class="cm">/* CAN configuration struct for SocketCAN interface &quot;can0&quot; */</span>
<span class="k">struct</span> <span class="n">csp_can_config</span> <span class="n">can_conf</span> <span class="o">=</span> <span class="p">{.</span><span class="n">ifc</span> <span class="o">=</span> <span class="s">&quot;can0&quot;</span><span class="p">};</span>

<span class="cm">/* Init buffer system with 10 packets of maximum 320 bytes each */</span>
<span class="n">csp_buffer_init</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">320</span><span class="p">);</span>

<span class="cm">/* Init CSP with address 1 */</span>
<span class="n">csp_init</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>

<span class="cm">/* Init the CAN interface with hardware filtering */</span>
<span class="n">csp_can_init</span><span class="p">(</span><span class="n">CSP_CAN_MASKED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">can_conf</span><span class="p">)</span>

<span class="cm">/* Setup default route to CAN interface */</span>
<span class="n">csp_route_set</span><span class="p">(</span><span class="n">CSP_DEFAULT_ROUTE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">csp_can_tx</span><span class="p">,</span> <span class="n">CSP_HOST_MAC</span><span class="p">);</span>

<span class="cm">/* Start router task with 500 word stack, OS task priority 1 */</span>
<span class="n">csp_route_start_task</span><span class="p">(</span><span class="mi">500</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="section" id="server">
<h2>3.2.3.9.2. Server<a class="headerlink" href="#server" title="Permalink to this headline">¶</a></h2>
<p>This example shows how to create a server task that listens for incoming connections. CSP should be initialized before starting this task. Note the use of <cite>csp_service_handler()</cite> as the default branch in the port switch case. The service handler will automatically reply to ICMP-like requests, such as pings and buffer status requests.</p>
<div class="highlight-c"><div class="highlight"><pre><span class="kt">void</span> <span class="nf">csp_task</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">parameters</span><span class="p">)</span> <span class="p">{</span>
    <span class="cm">/* Create socket without any socket options */</span>
    <span class="n">csp_socket_t</span> <span class="o">*</span><span class="n">sock</span> <span class="o">=</span> <span class="n">csp_socket</span><span class="p">(</span><span class="n">CSP_SO_NONE</span><span class="p">);</span>

    <span class="cm">/* Bind all ports to socket */</span>
    <span class="n">csp_bind</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="n">CSP_ANY</span><span class="p">);</span>

    <span class="cm">/* Create 10 connections backlog queue */</span>
    <span class="n">csp_listen</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>

    <span class="cm">/* Pointer to current connection and packet */</span>
    <span class="n">csp_conn_t</span> <span class="o">*</span><span class="n">conn</span><span class="p">;</span>
    <span class="n">csp_packet_t</span> <span class="o">*</span><span class="n">packet</span><span class="p">;</span>

    <span class="cm">/* Process incoming connections */</span>
    <span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
        <span class="cm">/* Wait for connection, 10000 ms timeout */</span>
        <span class="k">if</span> <span class="p">((</span><span class="n">conn</span> <span class="o">=</span> <span class="n">csp_accept</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="mi">10000</span><span class="p">))</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
            <span class="k">continue</span><span class="p">;</span>

        <span class="cm">/* Read packets. Timout is 1000 ms */</span>
        <span class="k">while</span> <span class="p">((</span><span class="n">packet</span> <span class="o">=</span> <span class="n">csp_read</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="mi">1000</span><span class="p">))</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">switch</span> <span class="p">(</span><span class="n">csp_conn_dport</span><span class="p">(</span><span class="n">conn</span><span class="p">))</span> <span class="p">{</span>
                <span class="k">case</span> <span class="nl">MY_PORT</span><span class="p">:</span>
                    <span class="cm">/* Process packet here */</span>
                <span class="k">default</span><span class="o">:</span>
                    <span class="cm">/* Let the service handler reply pings, buffer use, etc. */</span>
                    <span class="n">csp_service_handler</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">packet</span><span class="p">);</span>
                    <span class="k">break</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>

        <span class="cm">/* Close current connection, and handle next */</span>
        <span class="n">csp_close</span><span class="p">(</span><span class="n">conn</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="client">
<h2>3.2.3.9.3. Client<a class="headerlink" href="#client" title="Permalink to this headline">¶</a></h2>
<p>This example shows how to allocate a packet buffer, connect to another host and send the packet. CSP should be initialized before calling this function. RDP, XTEA, HMAC and CRC checksums can be enabled per connection, by setting the connection option to a bitwise OR of any combination of <cite>CSP_O_RDP</cite>, <cite>CSP_O_XTEA</cite>, <cite>CSP_O_HMAC</cite> and <cite>CSP_O_CRC</cite>.</p>
<div class="highlight-c"><div class="highlight"><pre><span class="kt">int</span> <span class="nf">send_packet</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span>

    <span class="cm">/* Get packet buffer for data */</span>
    <span class="n">csp_packet_t</span> <span class="o">*</span><span class="n">packet</span> <span class="o">=</span> <span class="n">csp_buffer_get</span><span class="p">(</span><span class="n">data_size</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">packet</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
        <span class="cm">/* Could not get buffer element */</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">&quot;Failed to get buffer element</span><span class="se">\\</span><span class="s">n&quot;</span><span class="p">);</span>
        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="cm">/* Connect to host HOST, port PORT with regular UDP-like protocol and 1000 ms timeout */</span>
    <span class="n">csp_conn_t</span> <span class="o">*</span><span class="n">conn</span> <span class="o">=</span> <span class="n">csp_connect</span><span class="p">(</span><span class="n">CSP_PRIO_NORM</span><span class="p">,</span> <span class="n">HOST</span><span class="p">,</span> <span class="n">PORT</span><span class="p">,</span> <span class="mi">1000</span><span class="p">,</span> <span class="n">CSP_O_NONE</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">conn</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
        <span class="cm">/* Connect failed */</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">&quot;Connection failed</span><span class="se">\\</span><span class="s">n&quot;</span><span class="p">);</span>
        <span class="cm">/* Remember to free packet buffer */</span>
        <span class="n">csp_buffer_free</span><span class="p">(</span><span class="n">packet</span><span class="p">);</span>
        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="cm">/* Copy message to packet */</span>
    <span class="kt">char</span> <span class="o">*</span><span class="n">msg</span> <span class="o">=</span> <span class="s">&quot;HELLO&quot;</span><span class="p">;</span>
    <span class="n">strcpy</span><span class="p">(</span><span class="n">packet</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">msg</span><span class="p">);</span>

    <span class="cm">/* Set packet length */</span>
    <span class="n">packet</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">msg</span><span class="p">);</span>

    <span class="cm">/* Send packet */</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">csp_send</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">packet</span><span class="p">,</span> <span class="mi">1000</span><span class="p">))</span> <span class="p">{</span>
        <span class="cm">/* Send failed */</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">&quot;Send failed</span><span class="se">\\</span><span class="s">n&quot;</span><span class="p">);</span>
        <span class="n">csp_buffer_free</span><span class="p">(</span><span class="n">packet</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="cm">/* Close connection */</span>
    <span class="n">csp_close</span><span class="p">(</span><span class="n">conn</span><span class="p">);</span>

    <span class="k">return</span> <span class="mi">0</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
</div>


           </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../../../../libfp_client/doc/libfp_client.html" class="btn btn-neutral float-right" title="3.3. Flight Planner (libfp_client)" accesskey="n">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="mtu.html" class="btn btn-neutral" title="3.2.3.8. Maximum Transfer Unit" accesskey="p"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2013-2019 GomSpace A/S. All rights reserved. ..

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../../../../../',
            VERSION:'2.1.1',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  false
        };
    </script>
      <script type="text/javascript" src="../../../../../_static/jquery.js"></script>
      <script type="text/javascript" src="../../../../../_static/underscore.js"></script>
      <script type="text/javascript" src="../../../../../_static/doctools.js"></script>

  

  
  
    <script type="text/javascript" src="../../../../../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>